<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Transaksiku</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/9.6.10/firebase-app-compat.js"></script>

    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/9.6.10/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/9.6.10/firebase-database-compat.js"></script>
    <!-- 
            initialize the SDK after all desired features are loaded, set useEmulator to false
            to avoid connecting the SDK to running emulators.
          -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

</head>

<body>
    <div class="container" id="signincontainer">
        <button disabled type="button" class="btn btn-default" id="btnSignin" style="float: right;">Sign in with
            Google</button>
    </div>
    <div class="container" id="maincontainer" style="display: none;">
        <h5 id="meH4Transaksyt" onclick=transaksiOnClick()>Transaksi</h5>
        <form id="formLubang" class="form-inline">
            <div class="form-check">
                <input type="radio" class="form-check-input" onclick="radiol5OnClick()" id="radiol5" name="lubang"
                    value="l5" checked>
                <label class="form-check-label" for="l5">L5</label>
                <input type="radio" class="form-check-input" onclick="radiol4OnClick()" id="radiol4" name="lubang"
                    value="l4">
                <label class="form-check-label" for="l4">L4</label>
                <input type="radio" class="form-check-input" onclick="radiol3OnClick()" id="radiol3" name="lubang"
                    value="l3">
                <label class="form-check-label" for="l3">L3</label>
                <input type="radio" class="form-check-input" onclick="radiol2OnClick()" id="radiol2" name="lubang"
                    value="l2">
                <label class="form-check-label" for="l2">L2</label>
                <input type="radio" class="form-check-input" onclick="radiol1OnClick()" id="radiol1" name="lubang"
                    value="l1">
                <label class="form-check-label" for="l1">L1</label>
            </div>
        </form>
        <form id="formTransaksi" class="form-inline">
            <div class="table-responsive" id="tableTransaksi"></div>
            <button type="button" class="btn btn-default" onclick="produkOnClick()" id="btnProduk"><span
                    class="glyphicon glyphicon-plus"></span></button>
            <button type="button" class="btn btn-default" onclick="noProdukOnClick()" id="btnNoProduk"><span
                    class="glyphicon glyphicon-question-sign"></span></button>
            <button type="button" class="btn btn-default" onclick="btnNewOnClick()" id="btnNew"
                style="float: right;">Selesai</button>
        </form>
        <form id="formSearch" class="form-inline" style="display: none;">
            <div class="input-group">
                <input class="form-control" id="inputSearch" type="text" placeholder="Cari..">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default" onclick="btnClearInputSearchOnClick()">
                        <span class="glyphicon glyphicon-remove"></span>
                    </button>
                </div>
            </div>
            <button type="button" class="btn btn-default" onclick="transaksiOnClick()" id="btnTransaksi"
                style="float: right;">Kembali</button>
            <div class="table-responsive" id="tableProduk"></div>
            <button type="button" class="btn btn-default" onclick="btnTambahpOnClick()" id="btnTambahp"><span
                    class="glyphicon glyphicon-plus"></span></button>
        </form>
        <form id="formEdit" class="form-horizontal" style="display: none;">
            <div class="form-group">
                <input type="hidden" class="form-control" id="id">
            </div>
            <!-- <div class="form-group">
                <label class="control-label col-sm-2" for="inputNama">Nama:</label>
                <div class="col-sm-10">
                    <input readonly class="form-control" id="inputNama" style="text-transform:uppercase">
                </div>
            </div> -->
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Nama</button>
                </div>
                <input class="form-control" id="inputNama" style="text-transform:uppercase">
            </div>
            <!-- <div class="form-group">
                <label class="control-label col-sm-2" for="inputLokasi">Lokasi:</label>
                <div class="col-sm-10">
                    <input class="form-control" id="inputLokasi" style="text-transform:uppercase">
                </div>
            </div> -->
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Lokasi</button>
                </div>
                <input class="form-control" id="inputLokasi" style="text-transform:uppercase">
            </div>
            <!-- <div class="form-group">
                <label class="control-label col-sm-2" for="inputHarga">Harga:</label>
                <div class="col-sm-10">
                    <input class="form-control" id="inputHarga" style="text-transform:uppercase">
                </div>
            </div> -->
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Harga</button>
                </div>
                <input class="form-control" id="inputHarga" style="text-transform:uppercase">
            </div>
            <!-- <div class="form-group">
                <label class="control-label col-sm-2" for="inputJumlah">Jumlah:</label>
                <div class="col-sm-10">
                    <input class="form-control" id="inputJumlah" style="text-transform:uppercase">
                </div>
            </div> -->
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default" onclick="$('#meInputJumlah').val('0')">Jumlah</button>
                </div>
                <input class="form-control" id="inputJumlah" style="text-transform:uppercase">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default" onclick="btnIncrementClick()"><span
                            class="glyphicon glyphicon-plus"></span></button>
                </div>
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default" onclick="btnDecrementClick()"><span
                            class="glyphicon glyphicon-minus"></span></button>
                </div>
            </div>
            <!-- <div class="form-group">
                <label class="control-label col-sm-2" for="inputTotal">Total:</label>
                <div class="col-sm-10">
                    <input class="form-control" id="inputTotal" style="text-transform:uppercase">
                </div>
            </div> -->
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Total</button>
                </div>
                <input class="form-control" id="inputTotal" style="text-transform:uppercase">
            </div>
            <button type="button" class="btn btn-default" onclick="btnTambahOnClick()" id="btnTambah"><span
                    class="glyphicon glyphicon-plus"></span></button>
            <button type="button" class="btn btn-default" onclick="btnUbahOnClick()" id="btnUbah"><span
                    class="glyphicon glyphicon-ok"></span></button>
            <button type="button" class="btn btn-default" onclick="btnBatalOnClick()" id="btnBatal"><span
                    class="glyphicon glyphicon-remove"></button>
            <button type="button" class="btn btn-default" onclick="btnSimpanOnClick()" id="btnSimpan"><span
                    class="glyphicon glyphicon-floppy-disk"></button>
            <button type="button" class="btn btn-default" onclick="btnKembaliOnClick()" id="btnKembali"
                style="float: right;">Kembali</button>
        </form>
        <form id="formEditp" class="form-horizontal" style="display: none;">
            <div class="form-group">
                <input type="hidden" class="form-control" id="hiddenIdp">
            </div>
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Nama</button>
                </div>
                <input class="form-control" id="inputNamap" style="text-transform:uppercase">
            </div>
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Stok</button>
                </div>
                <input class="form-control" id="inputStokp">
            </div>
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Update Stok</button>
                </div>
                <input class="form-control" id="inputUpdatestokp" readonly>
            </div>
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Beli</button>
                </div>
                <input class="form-control" id="inputBelip">
            </div>
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Jual</button>
                </div>
                <input class="form-control" id="inputHargap">
            </div>
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Het</button>
                </div>
                <input class="form-control" id="inputHetp">
            </div>
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Update Harga</button>
                </div>
                <input class="form-control" id="inputUpdatep" readonly>
            </div>
            <div class="input-group">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default">Lokasi</button>
                </div>
                <input class="form-control" id="inputLokasip" style="text-transform:uppercase">
            </div>
            <div class="form-group">
                <div class="col-sm-2"></div>
                <div class="col-sm-10">
                    <button type="button" class="btn btn-default" onclick="btnSimpanpOnClick()" id="btnSimpanp"><span
                            class="glyphicon glyphicon-ok"></span></button>
                    <button type="button" class="btn btn-default" onclick="btnKopipOnClick()" id="btnKopip"><span
                            class="glyphicon glyphicon-duplicate"></button>
                    <button type="button" class="btn btn-default" onclick="btnKembaliOnClick()" id="btnBatalp"
                        style="float: right;">Kembali</button>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-2"></div>
                <div class="col-sm-10 table-responsive">
                    <table class="table table-bordered table-striped" id="tableRiwayat" style="display: none;">
                    </table>
                </div>
            </div>
        </form>

    </div>

    <script>

        // ------------------------------------------- variable --------------------------------

        let mProdukDb = {};
        let moTransaksi = {};
        let moTransaksi5 = {};
        let moTransaksi4 = {};
        let moTransaksi3 = {};
        let moTransaksi2 = {};
        let moTransaksi1 = {};
        let moTransaksiLubang = 5;

        let meH4Transaksyt = document.getElementById("meH4Transaksyt");
        let meRadioL5 = document.getElementById("radiol5");
        let meRadioL4 = document.getElementById("radiol4");
        let meRadioL3 = document.getElementById("radiol3");
        let meRadioL2 = document.getElementById("radiol2");
        let meRadioL1 = document.getElementById("radiol1");

        let meFormSearch = document.getElementById("formSearch");
        let meInputSearch = document.getElementById("inputSearch");
        let meTableProduk = document.getElementById("tableProduk");

        let meFormEdit = document.getElementById("formEdit");
        let meHiddenId = document.getElementById("id");
        let meInputNama = document.getElementById("inputNama");
        let meInputLokasi = document.getElementById("inputLokasi");
        let meInputHarga = document.getElementById("inputHarga");
        let meInputJumlah = document.getElementById("inputJumlah");
        let meInputTotal = document.getElementById("inputTotal");
        let meBtnTambah = document.getElementById("btnTambah");
        let meBtnUbah = document.getElementById("btnUbah");
        let meBtnBatal = document.getElementById("btnBatal");
        let meBtnKembali = document.getElementById("btnKembali");

        let meFormEditp = document.getElementById("formEditp");
        let meHiddenIdp = document.getElementById("hiddenIdp");
        let meInputNamap = document.getElementById("inputNamap");
        let meInputStokp = document.getElementById("inputStokp");
        let meInputUpdatestokp = document.getElementById("inputUpdatestokp");
        let meInputBelip = document.getElementById("inputBelip");
        let meInputHargap = document.getElementById("inputHargap");
        let meInputHetp = document.getElementById("inputHetp");
        let meInputUpdatep = document.getElementById("inputUpdatep");
        let meInputLokasip = document.getElementById("inputLokasip");
        let meBtnSimpanp = document.getElementById("btnSimpanp");
        let meBtnKopip = document.getElementById("btnKopip");
        let meBtnBatalp = document.getElementById("btnBatalp");

        let meFormTransaksi = document.getElementById("formTransaksi");
        let meTableTransaksi = document.getElementById("tableTransaksi");
        let meInputGrandTotal = document.getElementById("inputGrandTotal");
        let meInputBayar = document.getElementById("inputBayar");
        let meInputKembalian = document.getElementById("inputKembalian");

        let mBeli = 0;
        let mHarga = 0;
        let mHet = 0;
        let mLokasi = "";

        let mStok = 0;
        let mUpdatestok = "";
        let mUpdate = "";

        let mdToday = new Date();
        let mddd = String(mdToday.getDate()).padStart(2, '0');
        let mdmm = String(mdToday.getMonth() + 1).padStart(2, '0'); //January is 0!
        let mdyyyy = mdToday.getFullYear();
        mdToday = mddd + '-' + mdmm + '-' + mdyyyy;
        meH4Transaksyt.innerHTML = "Transaksi Tgl " + mdToday
        // ------------------------------------------- logic --------------------------------

        generateTableTransaksi(moTransaksi);

        // ------------------------------------------- even --------------------------------

        $("#inputJumlah").bind('keyup mouseup', function () {
            hitungHarga();
        });

        $("#inputHarga").bind('keyup mouseup', function () {
            let lHarga = this.value.split('.').join('');
            let lTotal = lHarga * meInputJumlah.value
            meInputTotal.value = formatRupiah(lTotal.toString());
        });

        meInputJumlah.addEventListener('keyup', function (e) {

        });

        meInputTotal.addEventListener('keyup', function (e) {
            meInputTotal.value = formatRupiah(this.value);
        });

        meInputStokp.addEventListener('keyup', function (e) {
            meInputStokp.value = formatRupiah(this.value);
        });

        meInputBelip.addEventListener('keyup', function (e) {
            meInputBelip.value = formatRupiah(this.value);
        });

        meInputHargap.addEventListener('keyup', function (e) {
            meInputHargap.value = formatRupiah(this.value);
        });

        meInputHetp.addEventListener('keyup', function (e) {
            meInputHetp.value = formatRupiah(this.value);
        });

        meInputSearch.addEventListener('keyup', function (e) {
            meInputSearch.value = removeTrailingSlash(this.value);
        });

        meInputNama.addEventListener('keyup', function (e) {
            meInputNama.value = removeTrailingSlash(this.value);
        });

        meInputLokasi.addEventListener('keyup', function (e) {
            meInputLokasi.value = removeTrailingSlash(this.value);
        });

        meInputNamap.addEventListener('keyup', function (e) {
            meInputNamap.value = removeTrailingSlash(this.value);
        });

        meInputLokasip.addEventListener('keyup', function (e) {
            meInputLokasip.value = removeTrailingSlash(this.value);
        });

        // ------------------------------------------- click function --------------------------------

        function btnIncrementClick() {
            let liNum = parseInt(meInputJumlah.value);
            liNum = isNaN(liNum) ? 0 : liNum;
            liNum++;
            meInputJumlah.value = liNum;
            hitungHarga();
        }

        function btnDecrementClick() {
            let liNum = parseInt(meInputJumlah.value);
            liNum = isNaN(liNum) ? 0 : liNum;
            liNum--;
            meInputJumlah.value = liNum;
            hitungHarga();
        }

        function btnTambahpOnClick() {
            meHiddenIdp.value = "";
            meInputNamap.value = meInputSearch.value;
            meInputStokp.value = "";
            meInputUpdatestokp.value = "";
            meInputBelip.value = "";
            meInputHargap.value = "";
            meInputHetp.value = "";
            meInputUpdatep.value = "";
            meInputLokasip.value = "";
            meFormSearch.style.display = "none";
            meFormEditp.style.display = "block";
            meBtnHapusp.disabled = true;
            meBtnRiwayatp.disabled = true;
            meBtnKopip.disabled = true;
        }

        function btnSimpanpOnClick() {
            let id = meHiddenIdp.value;
            let updatestok = mdToday;
            let update = mdToday;
            let refdbproduk = firebase.database().ref('/produk');
            if (id.length > 0) {
                // update
                if (meInputBelip.value == mBeli && meInputHargap.value == mHarga && meInputHetp.value == mHet) {
                    update = meInputUpdatep.value;
                } else {
                    // update riwayat
                    if (typeof mBeli === "undefined") mBeli = 0;
                    if (typeof mHarga === "undefined") mHarga = 0;
                    if (typeof mHet === "undefined") mHet = 0;
                    let refdbupdate = firebase.database().ref('/update/' + id);
                    let updateday = mdyyyy + mdmm + mddd;
                    refdbupdate.update({
                        [updateday]: {
                            updateday: updateday,
                            beli: mBeli,
                            harga: mHarga,
                            het: mHet,
                            update: mdToday,
                            user: firebase.auth().currentUser.email
                        }
                    });
                }
                if (meInputStokp.value == mStok) {
                    updatestok = meInputUpdatestokp.value;
                }
                // update data
                refdbproduk.update({
                    [id + "/nama"]: meInputNamap.value.toUpperCase()
                    , [id + "/stok"]: meInputStokp.value
                    , [id + "/updatestok"]: updatestok
                    , [id + "/beli"]: meInputBelip.value
                    , [id + "/harga"]: meInputHargap.value
                    , [id + "/het"]: meInputHetp.value
                    , [id + "/update"]: update
                    , [id + "/lokasi"]: meInputLokasip.value
                    , [id + "/user"]: firebase.auth().currentUser.email
                });
            } else {
                // tambah
                let id = meInputNamap.value.split(' ').join('').toLowerCase();
                refdbproduk.update({
                    [id]: {
                        id: id,
                        nama: meInputNamap.value.toUpperCase(),
                        stok: meInputStokp.value,
                        updatestok: mdToday,
                        beli: meInputBelip.value,
                        harga: meInputHargap.value,
                        het: meInputHetp.value,
                        update: mdToday,
                        lokasi: meInputLokasip.value,
                        user: firebase.auth().currentUser.email
                    }
                });
            }
            meFormSearch.style.display = "block";
            meFormEdit.style.display = "none";
            meFormEditp.style.display = "none";
            meTableRiwayatp.style.display = "none";
        }

        function btnKopipOnClick() {
            if (meHiddenIdp.value != "") {
                meHiddenIdp.value = "";
            } else {

            }
        }

        function btnClearInputSearchOnClick() {
            meInputSearch.value = "";
            meInputSearch.focus();
            var $rows = $('#tableProduk tr');
            $rows.show();
        }

        function btnNewOnClick() {
            moTransaksi = {};
            generateTableTransaksi(moTransaksi);
        }

        function btnTambahOnClick() {
            moTransaksi = Object.assign(moTransaksi, {
                [meHiddenId.value]: {
                    "id": meHiddenId.value,
                    "nama": meInputNama.value,
                    "lokasi": meInputLokasi.value,
                    "harga": meInputHarga.value,
                    "jumlah": meInputJumlah.value,
                    "total": meInputTotal.value,
                }
            });
            generateTableTransaksi(moTransaksi);
            meFormEdit.style.display = "none";
            meFormSearch.style.display = "none";
            meFormTransaksi.style.display = "block";
        }

        function btnUbahOnClick() {
            btnTambahOnClick();
        }

        function btnBatalOnClick() {
            delete moTransaksi[meHiddenId.value];
            generateTableTransaksi(moTransaksi);
            meFormEdit.style.display = "none";
            meFormSearch.style.display = "none";
            meFormTransaksi.style.display = "block";
        }

        function btnSimpanOnClick() {
            let refdbproduk = firebase.database().ref('/produk');
            if (meHiddenId.value.length > 0) {
                if (meInputHarga.value.length > 0) {
                    if (meInputHarga.value != mHarga) {
                        // update riwayat
                        if (typeof mBeli === "undefined") mBeli = 0;
                        if (typeof mHarga === "undefined") mHarga = 0;
                        if (typeof mHet === "undefined") mHet = 0;
                        let refdbupdate = firebase.database().ref('/update/' + meHiddenId.value);
                        let updateday = mdyyyy + mdmm + mddd;
                        refdbupdate.update({
                            [updateday]: {
                                updateday: updateday,
                                beli: mBeli,
                                harga: mHarga,
                                het: mHet,
                                update: mdToday,
                                user: firebase.auth().currentUser.email
                            }
                        });
                    }
                    // update harga
                    refdbproduk.update({
                        [meHiddenId.value + "/harga"]: meInputHarga.value
                        , [meHiddenId.value + "/update"]: mdToday
                        , [meHiddenId.value + "/user"]: firebase.auth().currentUser.email
                    });
                }
                if (meInputLokasi.value.length > 0 && meInputLokasi.value != mLokasi) {
                    // update lokasi
                    refdbproduk.update({
                        [meHiddenId.value + "/lokasi"]: meInputLokasi.value
                        , [meHiddenId.value + "/update"]: mdToday
                        , [meHiddenId.value + "/user"]: firebase.auth().currentUser.email
                    });
                }
            }
            alert("perubahan telah tersimpan");
        }

        function btnKembaliOnClick() {
            meHiddenId.value = "";
            meInputNama.value = "";
            meInputLokasi.value = "";
            meInputHarga.value = "";
            meInputJumlah.value = "";
            meInputTotal.value = "";
            meFormEdit.style.display = "none";
            meFormEditp.style.display = "none";
            if (meFormSearch.style.display === "none") {
                meFormSearch.style.display = "block";
            } else {
                meFormTransaksi.style.display = "block";
            }
        }

        function kembalianOnClick() {
            let lGrandTotal = meInputGrandTotal.value.split('.').join('');
            let lBayar = meInputBayar.value.split('.').join('');
            meInputKembalian.value = formatRupiah((lBayar - lGrandTotal).toString());
        }

        function produkOnClick() {
            if (meFormSearch.style.display === "none") {
                meFormSearch.style.display = "block";
                meFormEdit.style.display = "none";
                meFormTransaksi.style.display = "none";
            } else {
                meFormSearch.style.display = "none";
            }
        }

        function noProdukOnClick() {
            alert(genRandonString(4));
        }

        function transaksiOnClick() {
            if (meFormTransaksi.style.display === "none") {
                meFormSearch.style.display = "none";
                meFormEdit.style.display = "none";
                meFormEditp.style.display = "none";
                meFormTransaksi.style.display = "block";
            } else {
                meFormTransaksi.style.display = "none";
            }
        }

        function tableProdukOnClick(lid) {
            meFormEdit.style.display = "block";
            meFormSearch.style.display = "none";
            meFormTransaksi.style.display = "none";
            meBtnTambah.disabled = false;
            meBtnUbah.disabled = true;
            meBtnBatal.disabled = true;
            meHiddenId.value = "";
            meInputNama.value = "";
            meInputLokasi.value = "";
            meInputHarga.value = "";
            meInputJumlah.value = "0";
            meInputTotal.value = "";
            for (var i in mProdukDb) {
                if (mProdukDb[i]["id"] == lid) {
                    meHiddenId.value = mProdukDb[i]["id"];
                    meInputNama.value = mProdukDb[i]["nama"];
                    meInputLokasi.value = mProdukDb[i]["lokasi"];
                    meInputHarga.value = mProdukDb[i]["harga"];
                    mBeli = mProdukDb[i]["beli"];
                    mHarga = mProdukDb[i]["harga"];
                    mHet = mProdukDb[i]["het"];
                    mStok = mProdukDb[i]["stok"];
                    mUpdatestok = mProdukDb[i]["updatestok"];
                    mUpdate = mProdukDb[i]["update"];
                    mLokasi = mProdukDb[i]["lokasi"];
                    if (mUpdate == mdToday) meInputNama.style.backgroundColor = 'lightgreen';
                    else meInputNama.style.backgroundColor = meInputHarga.style.backgroundColor;
                }
            }
        }

        function tableTransaksiOnClick(lid) {
            meFormEdit.style.display = "block";
            meFormSearch.style.display = "none";
            meFormTransaksi.style.display = "none";
            meBtnTambah.disabled = true;
            meBtnUbah.disabled = false;
            meBtnBatal.disabled = false;
            meHiddenId.value = "";
            meInputNama.value = "";
            meInputLokasi.value = "";
            meInputHarga.value = "";
            meInputJumlah.value = "";
            meInputTotal.value = "";
            for (var i in moTransaksi) {
                if (moTransaksi[i]["id"] == lid) {
                    meHiddenId.value = moTransaksi[i]["id"];
                    meInputNama.value = moTransaksi[i]["nama"];
                    meInputLokasi.value = moTransaksi[i]["lokasi"];
                    meInputHarga.value = moTransaksi[i]["harga"];
                    meInputJumlah.value = moTransaksi[i]["jumlah"];
                    meInputTotal.value = moTransaksi[i]["total"];
                }
            }
        }

        function radiol5OnClick() {
            switchTransaksi();
            moTransaksi = moTransaksi5;
            moTransaksiLubang = 5;
            generateTableTransaksi(moTransaksi);
        }

        function radiol4OnClick() {
            switchTransaksi();
            moTransaksi = moTransaksi4;
            moTransaksiLubang = 4;
            generateTableTransaksi(moTransaksi);
        }

        function radiol3OnClick() {
            switchTransaksi();
            moTransaksi = moTransaksi3;
            moTransaksiLubang = 3;
            generateTableTransaksi(moTransaksi);
        }

        function radiol2OnClick() {
            switchTransaksi();
            moTransaksi = moTransaksi2;
            moTransaksiLubang = 2;
            generateTableTransaksi(moTransaksi);
        }

        function radiol1OnClick() {
            switchTransaksi();
            moTransaksi = moTransaksi1;
            moTransaksiLubang = 1;
            generateTableTransaksi(moTransaksi);
        }

        // ------------------------------------------- function --------------------------------

        document.addEventListener('DOMContentLoaded', function () {
            try {
                let app = firebase.app();
                let features = [
                    'auth',
                    'database',
                ].filter(feature => typeof app[feature] === 'function');
            } catch (e) {
                console.error(e);
            }
        });

        $(document).ready(function () {
            $("#inputSearch").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $("#tableProduk tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
        });

        function hitungHarga() {
            let lHarga = meInputHarga.value.split('.').join('');
            let lTotal = lHarga * meInputJumlah.value;
            meInputTotal.value = formatRupiah(lTotal.toString());
        }

        function removeTrailingSlash(str) {
            return str.replace(/\/+$/, '');
        }

        function formatRupiah(angka, prefix) {
            var number_string = angka.replace(/[^,\d]/g, '').toString(),
                split = number_string.split(','),
                sisa = split[0].length % 3,
                rupiah = split[0].substr(0, sisa),
                ribuan = split[0].substr(sisa).match(/\d{3}/gi);

            if (ribuan) {
                separator = sisa ? '.' : '';
                rupiah += separator + ribuan.join('.');
            }

            rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
            return prefix == undefined ? rupiah : (rupiah ? 'Rp. ' + rupiah : '');
        }

        function generateTableProduk(db) {
            text = "<table class='table table-bordered table-striped'>";
            text += "<tr><th>Nama</th><th>Stok</th><th>Harga</th><th>Update</th></tr></thead>";
            text += "<tbody id='myTable'>";
            for (x in db) {
                text += "<tr>";
                text += "<td onclick=tableProdukOnClick('" + db[x].id + "')>" + db[x].nama + "</td>";
                text += "<td onclick=tableProdukOnClick('" + db[x].id + "')>" + db[x].stok + "</td>";
                text += "<td onclick=tableProdukOnClick('" + db[x].id + "')>" + db[x].harga + "</td>";
                text += "<td onclick=tableProdukOnClick('" + db[x].id + "')>" + db[x].update + "</td>";
                text += "</tr>";
            }
            text += "</tbody>"
            text += "</table>"
            meTableProduk.innerHTML = text;
        }

        function generateTableTransaksi(db) {
            let lGrandTotal = 0;

            text = "<table class='table table-bordered table-striped'>";
            text += "<tr><th>Nama</th><th>Harga</th><th>Jumlah</th><th>Total</th></tr></thead>";
            text += "<tbody id='myTable'>";
            for (x in db) {
                text += "<tr>";
                text += "<td onclick=tableTransaksiOnClick('" + db[x].id + "')>" + db[x].nama + "</td>";
                text += "<td onclick=tableTransaksiOnClick('" + db[x].id + "')>" + db[x].harga + "</td>";
                text += "<td onclick=tableTransaksiOnClick('" + db[x].id + "')>" + db[x].jumlah + "</td>";
                text += "<td style='text-align: right' onclick=tableTransaksiOnClick('" + db[x].id + "')>" + db[x].total + "</td>";
                text += "</tr>";
                let lTotal = db[x].total.split('.').join('');
                lGrandTotal = lGrandTotal + parseInt(lTotal);
            }
            text += "<tr><td colspan='2'>Grand Total</td><td colspan='2'><input  class=form-control style='text-align: right' id=inputGrandTotal readonly='true'></td></tr>";
            text += "<tr><td colspan='2'>Bayar</td><td colspan='2'><input class=form-control style='text-align: right' id=inputBayar></td></tr>";
            text += "<tr><td colspan='2' onclick='kembalianOnClick()'>Kembalian</td><td colspan='2'><input class=form-control style='text-align: right' id=inputKembalian readonly='true' onclick='kembalianOnClick()'></td></tr>";
            text += "</tbody>"
            text += "</table>"
            meTableTransaksi.innerHTML = text;

            meInputGrandTotal = document.getElementById("inputGrandTotal");
            meInputBayar = document.getElementById("inputBayar");
            meInputKembalian = document.getElementById("inputKembalian");

            meInputBayar.addEventListener('keyup', function (e) {
                meInputBayar.value = formatRupiah(this.value);
            });

            meInputGrandTotal.value = formatRupiah(lGrandTotal.toString());
        }

        function switchTransaksi() {
            switch (moTransaksiLubang) {
                case 5:
                    moTransaksi5 = moTransaksi;
                    break;
                case 4:
                    moTransaksi4 = moTransaksi;
                    break;
                case 3:
                    moTransaksi3 = moTransaksi;
                    break;
                case 2:
                    moTransaksi2 = moTransaksi;
                    break;
                case 1:
                    moTransaksi1 = moTransaksi;
                    break;
            }
        }

        function genRandonString(length) {
            var chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            var charLength = chars.length;
            var result = '';
            for (var i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * charLength));
            }
            return result;
        }

        function toggleSignIn() {
            if (!firebase.auth().currentUser) {
                var provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('https://www.googleapis.com/auth/plus.login');
                firebase.auth().signInWithRedirect(provider);
            } else {
                firebase.auth().signOut();
            }
            document.getElementById('btnSignin').disabled = true;
        }

        function initApp() {
            firebase.auth().getRedirectResult().then(function (result) {
                if (result.credential) {
                    var token = result.credential.accessToken;
                } else {

                }
                var user = result.user;
            }).catch(function (error) {
                var errorCode = error.code;
                var errorMessage = error.message;
                var email = error.email;
                var credential = error.credential;
                if (errorCode === 'auth/account-exists-with-different-credential') {
                    alert('You have already signed up with a different auth provider for that email.');
                } else {
                    console.error(error);
                }
            });

            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    // User is signed in.
                    var displayName = user.displayName;
                    document.getElementById('btnSignin').textContent = 'Sign out ' + user.email;
                    document.getElementById('maincontainer').style.display = "block"

                    // changed
                    firebase.database().ref('/produk').on('child_changed', (snapshot) => {
                        $changedPost = snapshot.val();
                        for (let i in mProdukDb) {
                            if (mProdukDb[i]["id"] == $changedPost.id) {
                                mProdukDb[i]["nama"] = $changedPost.nama;
                                mProdukDb[i]["lokasi"] = $changedPost.lokasi;
                                mProdukDb[i]["stok"] = $changedPost.stok;
                                mProdukDb[i]["updatestok"] = $changedPost.updatestok;
                                mProdukDb[i]["beli"] = $changedPost.beli;
                                mProdukDb[i]["harga"] = $changedPost.harga;
                                mProdukDb[i]["update"] = $changedPost.update;
                            }
                        }
                        generateTableProduk(mProdukDb);
                    });

                    // child_added
                    firebase.database().ref('/produk').on('child_added', (snapshot) => {
                        mProdukDb = Object.assign(mProdukDb, {
                            [snapshot.val().id]: {
                                "id": snapshot.val().id,
                                "nama": snapshot.val().nama,
                                "lokasi": snapshot.val().lokasi,
                                "stok": snapshot.val().stok,
                                "updatestok": snapshot.val().updatestok,
                                "beli": snapshot.val().beli,
                                "harga": snapshot.val().harga,
                                "update": snapshot.val().update
                            }
                        });
                        generateTableProduk(mProdukDb);
                    });

                    // child_removed
                    firebase.database().ref('/produk').on('child_removed', (snapshot) => {
                        for (var i in mProdukDb) {
                            if (mProdukDb[i]["id"] == snapshot.val().id) {
                                delete mProdukDb[i];
                            }
                        }
                        generateTableProduk(mProdukDb);
                    });
                } else {
                    // User is signed out.
                    document.getElementById('btnSignin').textContent = 'Sign in with Google';
                    document.getElementById('maincontainer').style.display = "none"
                }
                document.getElementById('btnSignin').disabled = false;
            });

            document.getElementById('btnSignin').addEventListener('click', toggleSignIn, false);
        }

        window.onload = function () {
            initApp();
        };

    </script>

</body>

</html>