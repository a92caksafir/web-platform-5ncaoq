<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Welcome to Firebase Hosting</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/9.6.10/firebase-app-compat.js"></script>

    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/9.6.10/firebase-auth-compat.js"></script>
    <script
      defer
      src="/__/firebase/9.6.10/firebase-database-compat.js"
    ></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
  </head>

  <!-- --------------------------------------------------------------------------------------------- -->

  <body>
    <div class="container">
      <button
        disabled
        type="button"
        class="btn btn-default"
        id="quickstart-sign-in"
      >
        <span class="glyphicon glyphicon-log-in"></span>Sign in with Google
      </button>
    </div>
    <div class="container" id="maincontainer">
      <h4 onclick="toggleSearch()">
        <span class="glyphicon glyphicon-search"></span>Search
      </h4>
      <form id="formSearch" class="form-inline">
        <div class="form-group">
          <label>Search :</label>
          <input
            class="form-control"
            id="myInput"
            type="text"
            placeholder="Search.."
          />
        </div>
        <div id="demo" class="table-responsive"></div>
        <button
          type="button"
          class="btn btn-default"
          onclick="btnTambahOnClick()"
          id="btnSimpan"
        >
          <span class="glyphicon glyphicon-plus"></span>Tambah
        </button>
      </form>
      <form class="form-inline" id="formEdit" style="display: none">
        <div class="form-group">
          <label for="name">Id:</label>
          <input class="form-control" id="id" />
        </div>
        <div class="form-group">
          <label for="name">Nama:</label>
          <input class="form-control" id="name" />
        </div>
        <div class="form-group">
          <label for="height">Height:</label>
          <input class="form-control" id="height" />
        </div>
        <div class="form-group">
          <label for="length">Length:</label>
          <input class="form-control" id="length" />
        </div>
        <div class="form-group">
          <label for="weight">Weight:</label>
          <input class="form-control" id="weight" />
        </div>
        <button
          type="button"
          class="btn btn-default"
          onclick="btnSimpanOnClick()"
          id="btnSimpan"
        >
          Simpan
        </button>
        <button
          type="button"
          class="btn btn-default"
          onclick="btnHapusOnClick()"
          id="btnHapus"
        >
          Hapus
        </button>
      </form>
    </div>
    <div
      class="container"
      id="debugcontainer"
      style="display: none; color: white"
    >
      <h2>Debug</h2>
      <form class="form-inline">
        <p id="load">Firebase SDK Loading&hellip;</p>
        <p id="jumlah"></p>
        <p id="debug"></p>
        <div class="quickstart-user-details-container">
          <div>Firebase auth object value:</div>
          <div id="quickstart-account-details">null</div>
          <div>Google OAuth Access Token:</div>
          <div id="quickstart-oauthtoken">null</div>
        </div>
      </form>
    </div>
    <br />
    <br />
    <!-- --------------------------------------------------------------------------------------------- -->

    <script>
      $(document).ready(function () {
        $('#myInput').on('keyup', function () {
          var value = $(this).val().toLowerCase();
          $('#myTable tr').filter(function () {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
          });
        });
      });

      document.addEventListener('DOMContentLoaded', function () {
        $db = {};
        const loadEl = document.querySelector('#load');
        try {
          let app = firebase.app();
          let features = ['auth', 'database'].filter(
            (feature) => typeof app[feature] === 'function'
          );
          loadEl.textContent = `Firebase SDK loaded with ${features.join(
            ', '
          )}`;
        } catch (e) {
          console.error(e);
          loadEl.textContent =
            'Error loading the Firebase SDK, check the console.';
        }

        // ####################mylogic##########################

        // Get db
        var refdbdinosaurs = firebase.database().ref('/dinosaurs');
        refdbdinosaurs.once('value', (snapshot) => {
          // $db = snapshot.val();
          $jumlah = 0;
          for (var i in $db) {
            $jumlah++;
          }
          document.getElementById('jumlah').innerHTML =
            'Jumlah data : ' + $jumlah;
          // generateTable($db);
        });

        // Get the data on a post that has changed
        firebase
          .database()
          .ref('/dinosaurs')
          .on('child_changed', (snapshot) => {
            $changedPost = snapshot.val();
            for (var i in $db) {
              if ($db[i]['name'] == $changedPost.name) {
                $db[i]['order'] = $changedPost.order;
                $db[i]['height'] = $changedPost.height;
                $db[i]['length'] = $changedPost.length;
                $db[i]['weight'] = $changedPost.weight;
              }
            }
            generateTable($db);
          });

        // Get the data on a post that has added
        firebase
          .database()
          .ref('/dinosaurs')
          .on('child_added', (snapshot) => {
            console.log('child_added');
            $db = Object.assign($db, {
              [snapshot.val().name]: {
                name: snapshot.val().name,
                order: snapshot.val().order,
                height: snapshot.val().height,
                length: snapshot.val().length,
                weight: snapshot.val().weight,
              },
            });
            generateTable($db);
          });

        // Get the data on a post that has been removed
        firebase
          .database()
          .ref('/dinosaurs')
          .on('child_removed', (snapshot) => {
            console.log('child_removed');
            for (var i in $db) {
              if ($db[i]['name'] == snapshot.val().name) {
                delete $db[i];
              }
            }
            generateTable($db);
          });
      });

      function generateTable(db) {
        text = "<table class='table table-bordered table-striped'>";
        text +=
          '<tr><th>Name</th><th>Height</th><th>length</th><th>Weight</th><th>Name</th><th>Height</th><th>length</th><th>Weight</th></tr></thead>';
        text += "<tbody id='myTable'>";
        for (x in db) {
          text += '<tr>';
          text +=
            "<td onclick=tableonclick('" +
            db[x].name +
            "')>" +
            db[x].name +
            '</td>';
          text +=
            "<td onclick=tableonclick('" +
            db[x].name +
            "')>" +
            db[x].height +
            '</td>';
          text +=
            "<td onclick=tableonclick('" +
            db[x].name +
            "')>" +
            db[x].length +
            '</td>';
          text +=
            "<td onclick=tableonclick('" +
            db[x].name +
            "')>" +
            db[x].weight +
            '</td>';
          text +=
            "<td onclick=tableonclick('" +
            db[x].name +
            "')>" +
            db[x].name +
            '</td>';
          text +=
            "<td onclick=tableonclick('" +
            db[x].name +
            "')>" +
            db[x].height +
            '</td>';
          text +=
            "<td onclick=tableonclick('" +
            db[x].name +
            "')>" +
            db[x].length +
            '</td>';
          text +=
            "<td onclick=tableonclick('" +
            db[x].name +
            "')>" +
            db[x].weight +
            '</td>';
          text += '</tr>';
        }
        text += '</tbody>';
        text += '</table>';
        document.getElementById('demo').innerHTML = text;
      }

      function tableonclick(id) {
        // document.getElementById("input").value = id;
        document.getElementById('formEdit').style.display = 'block';
        cari(id);
        toggleSearch();
      }

      function btnCariOnClick() {
        var searchVal = document.getElementById('input').value;
        cari(searchVal);
      }

      function btnSimpanOnClick() {
        $id = document.getElementById('id').value;
        $name = document.getElementById('name').value;
        $height = document.getElementById('height').value;
        $length = document.getElementById('length').value;
        $weight = document.getElementById('weight').value;
        var refdbdinosaurs = firebase.database().ref('/dinosaurs');
        if ($id.length > 0) {
          refdbdinosaurs.update({
            [$name + '/height']: $height,
            [$name + '/length']: $length,
            [$name + '/weight']: $weight,
          });
        } else {
          refdbdinosaurs.update({
            [$name]: {
              name: $name,
              height: $height,
              length: $length,
              weight: $weight,
            },
          });
        }
        document.getElementById('formSearch').style.display = 'block';
        document.getElementById('formEdit').style.display = 'none';
      }

      function btnHapusOnClick() {
        if (
          confirm(
            'Hapus data ' + document.getElementById('name').value + ' ?'
          ) == true
        ) {
          $name = document.getElementById('name').value;
          let refdbdinosaurs = firebase.database().ref('/dinosaurs');
          refdbdinosaurs.child($name).remove();
          document.getElementById('formSearch').style.display = 'block';
          document.getElementById('formEdit').style.display = 'none';
        }
      }

      function btnTambahOnClick() {
        document.getElementById('id').value = '';
        document.getElementById('id').readOnly = true;
        document.getElementById('name').value = '';
        document.getElementById('height').value = '';
        document.getElementById('length').value = '';
        document.getElementById('weight').value = '';
        document.getElementById('formSearch').style.display = 'none';
        document.getElementById('formEdit').style.display = 'block';
      }

      function cariDb(key) {
        console.log('cari db ' + key);
        const dbRef = firebase.database().ref('/dinosaurs');
        dbRef
          .child(key)
          .get()
          .then((snapshot) => {
            if (snapshot.exists()) {
              console.log(snapshot.val());
            } else {
              console.log('No data available');
            }
          })
          .catch((error) => {
            console.error(error);
          });
      }

      function cari(searchVal) {
        console.log(searchVal);
        var isExist;
        $isExist = false;
        // document.getElementById("error").innerHTML = "";
        document.getElementById('id').value = '';
        document.getElementById('name').value = '';
        document.getElementById('height').value = '';
        document.getElementById('length').value = '';
        document.getElementById('weight').value = '';
        for (var i in $db) {
          if ($db[i]['name'] == searchVal) {
            document.getElementById('id').value = i;
            document.getElementById('name').value = $db[i]['name'];
            document.getElementById('height').value = $db[i]['height'];
            document.getElementById('length').value = $db[i]['length'];
            document.getElementById('weight').value = $db[i]['weight'];
            $isExist = true;
          }
        }
        if (!$isExist)
          document.getElementById('error').innerHTML = 'Data tidak ditemukan';
        document.getElementById('debug').innerHTML = $isExist;
      }

      function enter(e) {
        if (e.keyCode == 13) {
          document.getElementById('myBtn').click();
          return false;
        }
      }

      function toggleSearch() {
        let x = document.getElementById('formSearch');
        if (x.style.display === 'none') {
          x.style.display = 'block';
          document.getElementById('formEdit').style.display = 'none';
        } else {
          x.style.display = 'none';
        }
      }

      function toggleSignIn() {
        if (!firebase.auth().currentUser) {
          var provider = new firebase.auth.GoogleAuthProvider();
          provider.addScope('https://www.googleapis.com/auth/plus.login');
          firebase.auth().signInWithRedirect(provider);
        } else {
          firebase.auth().signOut();
        }
        document.getElementById('quickstart-sign-in').disabled = true;
      }

      function initApp() {
        // Result from Redirect auth flow.
        firebase
          .auth()
          .getRedirectResult()
          .then(function (result) {
            if (result.credential) {
              // This gives you a Google Access Token. You can use it to access the Google API.
              var token = result.credential.accessToken;
              document.getElementById('quickstart-oauthtoken').textContent =
                token;
            } else {
              document.getElementById('quickstart-oauthtoken').textContent =
                'null';
            }
            // The signed-in user info.
            var user = result.user;
          })
          .catch(function (error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
            // The email of the user's account used.
            var email = error.email;
            // The firebase.auth.AuthCredential type that was used.
            var credential = error.credential;
            if (errorCode === 'auth/account-exists-with-different-credential') {
              alert(
                'You have already signed up with a different auth provider for that email.'
              );
              // If you are using multiple auth providers on your app you should handle linking
              // the user's accounts here.
            } else {
              console.error(error);
            }
          });

        // Listening for auth state changes.
        firebase.auth().onAuthStateChanged(function (user) {
          if (user) {
            // User is signed in.
            var displayName = user.displayName;
            document.getElementById('quickstart-sign-in').textContent =
              'Sign out ' + user.email;
            document.getElementById('quickstart-account-details').textContent =
              JSON.stringify(user, null, '  ');
            document.getElementById('maincontainer').style.display = 'block';
          } else {
            // User is signed out.
            document.getElementById('quickstart-sign-in').textContent =
              'Sign in with Google';
            document.getElementById('quickstart-account-details').textContent =
              'null';
            document.getElementById('quickstart-oauthtoken').textContent =
              'null';
            document.getElementById('maincontainer').style.display = 'none';
          }
          document.getElementById('quickstart-sign-in').disabled = false;
        });

        document
          .getElementById('quickstart-sign-in')
          .addEventListener('click', toggleSignIn, false);
      }

      window.onload = function () {
        initApp();
      };
    </script>
  </body>
</html>
